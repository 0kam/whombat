on:
  release:
    types:
      - created

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt pyinstaller sphinx
          sphinx-autobuild sphinx-book-theme
      - run: sphinx-build -b html 'docs/source' 'docs/build'
      - run: pyinstaller
          --add-data "whombat/migrations;whombat/migrations"
          --add-data "whombat/static;whombat/static"
          --add-data "whombat/templates;whombat/templates"
          --add-data "docs/build;docs/build"
          --hidden-import "logging.config"
          --hidden-import "passlib.handlers.bcrypt"
          --onefile app.py
      - run: mv "dist/app.exe" "dist/whombat-windows-${{ github.ref_name }}.exe"
      - uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: 'dist/whombat-windows-${{ github.ref_name }}.exe'

  build-ubuntu:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt pyinstaller sphinx
          sphinx-autobuild sphinx-book-theme
      - run: sphinx-build -b html 'docs/source' 'docs/build'
      - run: pyinstaller
          --add-data "whombat/migrations:whombat/migrations"
          --add-data "whombat/static:whombat/static"
          --add-data "whombat/templates:whombat/templates"
          --add-data "docs/build:docs/build"
          --hidden-import "logging.config"
          --hidden-import "passlib.handlers.bcrypt"
          --onefile app.py
      - run: mv "dist/app" "dist/whombat-ubuntu-${{ github.ref_name }}"
      - uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: 'dist/whombat-ubuntu-${{ github.ref_name }}'

  build-macos:
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - run: pip install -r requirements.txt pyinstaller sphinx
          sphinx-autobuild sphinx-book-theme
      - run: sphinx-build -b html 'docs/source' 'docs/build'
      - run: pyinstaller
          --add-data "whombat/migrations:whombat/migrations"
          --add-data "whombat/static:whombat/static"
          --add-data "whombat/templates:whombat/templates"
          --add-data "docs/build:docs/build"
          --hidden-import "logging.config"
          --hidden-import "passlib.handlers.bcrypt"
          --onefile app.py
      - run: mv "dist/app" "dist/whombat-macos-${{ github.ref_name }}"
      - uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: 'dist/whombat-macos-${{ github.ref_name }}'
