name: Bundle App
on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - uses: actions/setup-node@v1
        with:
          node-version: 21
      - shell: pwsh
        run: scripts/update_front.ps1
      - shell: pwsh
        run: scripts/update_guide.ps1
      - shell: pwsh
        run: scripts/bundle.ps1
      - run: mv "dist/app.exe" "dist/whombat-windows-${{ github.ref_name }}.exe"
      - uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: "dist/whombat-windows-${{ github.ref_name }}.exe"

  build-ubuntu:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - uses: actions/setup-node@v1
        with:
          node-version: 21
      - run: npm cache clean --force
      - run: make build-frontend
      - run: make build-guide
      - run: make bundle-pyinstaller
      - run: |
          mkdir dist/
          chmod +x "back/dist/whombat"
          mv back/dist/whombat "dist/whombat-ubuntu-${{ github.ref_name }}"
      - uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: "dist/whombat-ubuntus-${{ github.ref_name }}"

  build-macos:
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - uses: actions/setup-node@v1
        with:
          node-version: 21
      - run: make build-frontend
      - run: make build-guide
      - run: make bundle-pyinstaller
      - run: |
          mkdir dist/
          chmod +x "back/dist/whombat"
          mv back/dist/whombat "dist/whombat-macos-${{ github.ref_name }}"
      - uses: shogo82148/actions-upload-release-asset@v1
      - uses: shogo82148/actions-upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: "dist/whombat-macos-${{ github.ref_name }}"
